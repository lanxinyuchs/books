#!/usr/bin/env expect
## ----------------------------------------------------------
## Copyright (c) Ericsson AB 2013 All rights reserved.
##
## The information in this document is the property of Ericsson.
##
## Except as specifically authorized in writing by Ericsson, the
## receiver of this document shall keep the information contained
## herein confidential and shall protect the same in whole or in
## part from disclosure and dissemination to third parties.
##
## Disclosure and disseminations to the receivers employees shall
## only be made on a strict need to know basis.
## ----------------------------------------------------------
## #1.    REVISION LOG
## ----------------------------------------------------------
## Rev        Date         Name        What
## --------   --------     --------    ------------------------
## R2A/1      2012-03-19   etxjovp     Created
## R2A/2      2012-04-30   etxjovp     Took care of Permission denied
## ----------------------------------------------------------


proc usage {} {
    puts "rcs_ssh NODE CMD"   
    puts "Example:     rcs_ssh  dus031 \"ls -l /home/sirpa/dev_patches/\""
    exit 
}

if { $argc != 2 } {
    usage
}
set NODE [lindex $argv 0 ]
set CMD [lindex $argv 1 ]
set USER "root"
set PASSWORD "root"
set TIMEOUT 2
set Line [exec cat /proj/webdocs/rbs-rde-wiki/root/data/Main/LabConfig.txt | grep $NODE ]
set Items [split $Line "|"]
set IP [lindex $Items 10]

set timeout $TIMEOUT
log_user 0
proc cmd {Ip Cmd} {
    global USER PASSWORD
puts "ssh ${USER}@${Ip} $Cmd"
    spawn ssh ${USER}@${Ip} $Cmd
    match_max 5000
    expect {
        "password:" {
            exp_send "${PASSWORD}\r"
            exp_continue
        }
         "Password:" {
            exp_send "${PASSWORD}\r"
            exp_continue
        }
        "(yes/no)" {
            exp_send "yes\r"
            exp_continue
        }
        eof {
             wait
             return $expect_out(buffer)
        }
        "Connection refused" {
            close
            wait
            return "no_login"
        }
        "Permission denied, please try again." {
            close
            wait
            return "no_login"
        }
        "Connection closed by remote host" {
            close
            wait
            return "no_login"
        }
        timeout {
            close
            wait
            return "no_login"
        }
    }
}



set HOME $::env(HOME)
puts "rm -f ${HOME}/.ssh/known_hosts"
exec rm -f ${HOME}/.ssh/known_hosts
set Exit 0
if {[regexp {([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+).*} $IP matched IP2]} {
set Result [cmd $IP2 $CMD]		
    if { $Result == "no_login"} {
       set Exit 1		    
      } 		
    puts "$Result"
}
exit $Exit
