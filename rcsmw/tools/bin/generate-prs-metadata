#!/usr/bin/env bash

set -euo pipefail

# Print basic usage information
#

print_usage () {
    echo "Usage: $(basename $0) <artifact> [<out-file>]"
    echo " Generate a PRS metadata file for the given product"
    echo "Options:"
    echo "  --help:     show this help"
    echo "  --man-page: display the man page"
}

# Declared variables

args=''


# Print arguments to stderr and exit with a non-zero value
# param: text to print
die() {
    echo "$@" 1>&2
    exit 1
}

# Parse options
#

handle_options () {

    # Program options
    GETOPT=$(getopt --options 'hm' --long help,man-page: -n $0 -- "$@")

    if [[ $? != 0 ]] ; then echo "Error parsing arguments." >&2 ; exit 1 ; fi

    eval set -- "$GETOPT"

    while true ; do
        case "$1" in
          --help)     print_usage; exit ;;
          --man-page) print_man_page; exit ;;
          --) shift ; break ;;
          *) echo "Internal error!" ; exit 1 ;;
        esac
        shift
    done

    # $@ is local since we are in a function. Copy it to the global variable.
    args="$@"
}


# Main program.

main () {

    [[ ${1-} ]] || die Error: missing argument "<artifact>"
    local artifact=$1

    if [[ ${2-} ]]; then
        local outfile=$2
    else
        metadata=$(cicd read-key $artifact metadata)
        [[ $metadata ]] || die Error: '"'$artifact'"' has no metadata configured
        outfile=$(cicd get-file-name $metadata)
    fi
    generate-from-template prs-metadata $artifact $outfile
}


######################################################################
### Man page should be the last part in the file

print_man_page () {
    if [[ ! $PAGER ]]; then
        export PAGER=less
    fi

    if perldoc -l Term::ANSIColor > /dev/null 2>&1; then
        color=--color
    fi

    ( pod2text --loose $color - <<EOPOD

=head1 NAME

$(basename $0) - generate PRS metadata file

=head1 SYNOPSIS

$(basename $0) I<artifact> [ I<out-file> ]

$(basename $0) { B<--help> | B<--man-page> }

=head1 DESCRIPTION

Generates the PRS metadata file for a product, based on the information
in the delivery config files for CICDSYS.

=head1 OPTIONS

=over 4

=item B<--help>

Print short help text

=item B<--man-page>

Show this man page

=back

=head1 SEE ALSO

-

EOPOD
  ) | $PAGER
}

# The sole purpose of the calls below is to allow the man page to stay at the end
# of the file

handle_options "$@"
main $args
